<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Boost your mood with MoodTask! Select your mood and get quick, science-backed tasks to feel better in seconds.">
    <meta name="keywords" content="moodtask, mood boost, mental health, quick tasks">
    <meta name="robots" content="index, follow">
    <title>MoodTask | Boost Your Mood in Seconds</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1511837633001567" crossorigin="anonymous" data-ad-init-load="300"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4985X51W1J"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-4985X51W1J');
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <nav id="nav">
        <div class="logo">Mood<span>Task</span></div>
        <div class="nav-links">
            <a href="index.html" class="nav-button active">Home</a>
            <a href="about.html" class="nav-button">About</a>
        </div>
    </nav>

    <div class="hero-section">
        <h1>Boost Your Mood in Seconds</h1>
        <h2>Select Your Mood and Get a Quick, Science-Backed Task</h2>
        <button class="hero-cta" onclick="scrollToMoodPrompt()">Get Started</button>
    </div>

    <div id="intro-content">
        <h2 class="section-heading">Why MoodTask?</h2>
        <div class="feature-cards">
            <div class="feature-card">
                <span class="feature-icon">‚ö°</span>
                <h3>Quick Tasks</h3>
                <p>Most tasks take less than a minute, perfect for busy days.</p>
            </div>
            <div class="feature-card">
                <span class="feature-icon">üß†</span>
                <h3>Science-Backed</h3>
                <p>Tasks are rooted in psychology and neuroscience research.</p>
            </div>
            <div class="feature-card">
                <span class="feature-icon">üéØ</span>
                <h3>Personalized</h3>
                <p>Get activities tailored to your current mood.</p>
            </div>
        </div>
    </div>

    <div id="mood-prompt">
        <h2 id="instruction">How Are You Feeling Right Now?</h2>
        <div id="mood-buttons">
            <button data-mood="tired" data-tooltip="Feeling low-energy or sleepy?"><span class="mood-icon">üò¥</span> Tired</button>
            <button data-mood="stressed" data-tooltip="Feeling overwhelmed or tense?"><span class="mood-icon">üò∞</span> Stressed</button>
            <button data-mood="sad" data-tooltip="Feeling down or emotional?"><span class="mood-icon">üò¢</span> Sad</button>
            <button data-mood="anxious" data-tooltip="Feeling nervous or worried?"><span class="mood-icon">üòü</span> Anxious</button>
            <button data-mood="angry" data-tooltip="Feeling frustrated or upset?"><span class="mood-icon">üò†</span> Angry</button>
            <button data-mood="bored" data-tooltip="Feeling restless or uninspired?"><span class="mood-icon">üòê</span> Bored</button>
            <button data-mood="happy" data-tooltip="Feeling cheerful or content?"><span class="mood-icon">üòä</span> Happy</button>
            <button data-mood="lonely" data-tooltip="Feeling isolated or disconnected?"><span class="mood-icon">üòî</span> Lonely</button>
        </div>
    </div>

    <div id="result"></div>

    <div class="tools-container">
        <button class="tool-button breathing" onclick="openPopup('breathing')"><i class="fas fa-wind tool-icon"></i> Breathing Exercise</button>
        <button class="tool-button gratitude" onclick="openPopup('gratitude')"><i class="fas fa-heart tool-icon"></i> Gratitude Note</button>
        <button class="tool-button soundscape" onclick="openPopup('soundscape')"><i class="fas fa-headphones tool-icon"></i> Soundscape</button>
        <button class="tool-button punching" onclick="openPopup('punching')"><i class="fas fa-fist-raised tool-icon"></i> Punching Bag</button>
        <button class="tool-button stretch" onclick="openPopup('stretch')"><i class="fas fa-child tool-icon"></i> Quick Stretch</button>
        <button class="tool-button doodle" onclick="openPopup('doodle')"><i class="fas fa-paint-brush tool-icon"></i> Doodle Pad</button>
        <button class="tool-button dance" onclick="openPopup('dance')"><i class="fas fa-music tool-icon"></i> Dance Break</button>
        <button class="tool-button worry" onclick="openPopup('worry')"><i class="fas fa-trash tool-icon"></i> Worry Shredder</button>
        <button class="tool-button color" onclick="openPopup('color')"><i class="fas fa-palette tool-icon"></i> Color Shift</button>
    </div>

    <div id="banner">
        <p class="disclaimer"><em>Affiliate Disclosure: MoodTask may earn a commission if you click the link below and make a purchase, at no additional cost to you.</em></p>
        <p class="ad-label">Sponsored: Support Your Mental Health</p>
        <a href="https://onlinetherapy.go2cloud.org/SHjO?file_id=78" class="banner-link">
            <img src="https://media.go2speed.org/brand/files/onlinetherapy/2/online-therapy-com-logo-728x90.png" alt="Online Therapy Banner" class="banner-img">
        </a>
        <img src="https://onlinetherapy.go2cloud.org/aff_i?offer_id=2&file_id=78&aff_id=4837" width="0" height="0" style="position:absolute;visibility:hidden;" border="0" />
    </div>

    <button id="share" aria-label="Share this page on X">
        <svg class="share-logo" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        <span>Share on X</span>
    </button>

    <div id="donate">
        <h3>Support MoodTask</h3>
        <p>If you find MoodTask helpful, please consider supporting us!</p>
        <a href="https://www.buymeacoffee.com/moodtask" target="_blank" rel="noopener noreferrer">
            <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me a Coffee" style="width: 150px; height: auto;">
        </a>
    </div>

    <footer>
        <div class="footer-columns">
            <div class="footer-column">
                <h4>MoodTask</h4>
                <p>Transform your mood in seconds with fun, quick activities tailored to how you feel.</p>
            </div>
            <div class="footer-column">
                <h4>Quick Links</h4>
                <a href="index.html" class="footer-link">Home</a>
                <a href="about.html" class="footer-link">About</a>
            </div>
            <div class="footer-column">
                <h4>Legal</h4>
                <a href="privacy.html" class="footer-link">Privacy Policy</a>
                <a href="terms.html" class="footer-link">Terms of Use</a>
            </div>
        </div>
        <p class="disclaimer"><em>General Disclaimer: MoodTask provides this website for informational purposes only. We are not responsible for any errors, omissions, or outcomes resulting from the use of this information. Users follow external links, including those to third-party sites, at their own risk. Always review the terms and privacy policies of external websites.</em></p>
        <p class="copyright">¬© 2025 MoodTask. All rights reserved.</p>
    </footer>

    <!-- Updated Popups -->
    <div id="breathingPopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('breathing')">‚úï</button>
            <h4>Breathing Exercise</h4>
            <p>Follow the rhythm to calm your mind.</p>
            <div id="breathing-circle">Start</div>
            <p id="breathing-step">Inhale</p>
            <p id="breathing-instruction">Click Start to begin</p>
            <p id="breathing-timer">Time remaining: 60s</p>
            <div class="progress-container">
                <div class="progress-bar" id="breathing-progress"></div>
            </div>
            <button class="action-button" onclick="startBreathing()">Start</button>
        </div>
    </div>

    <div id="gratitudePopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('gratitude')">‚úï</button>
            <h4>Gratitude Note</h4>
            <p>Write down three things you're grateful for today.</p>
            <textarea id="gratitude-text" placeholder="I‚Äôm grateful for..."></textarea>
            <button class="action-button" onclick="saveGratitude()">Save</button>
        </div>
    </div>

    <div id="soundscapePopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('soundscape')">‚úï</button>
            <h4>Relaxing Soundscape</h4>
            <p>Choose a sound and relax for 90 seconds.</p>
            <select class="sound-select" id="soundscape-select">
                <option value="rain">Rain</option>
                <option value="waves">Ocean Waves</option>
                <option value="forest">Forest</option>
            </select>
            <div class="audio-controls">
                <button class="audio-btn" id="play-btn"><i class="fas fa-play"></i></button>
            </div>
            <div class="volume-control">
                <label for="volume-slider">Volume:</label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
            </div>
            <p id="soundscape-timer">Time remaining: 90s</p>
            <div class="progress-container">
                <div class="progress-bar" id="soundscape-progress"></div>
            </div>
        </div>
    </div>

    <div id="punchingPopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('punching')">‚úï</button>
            <h4>Punching Bag</h4>
            <p>Click the bag to release your stress! (30 seconds)</p>
            <div id="punching-bag">0</div>
            <p id="punching-timer">Time remaining: 30s</p>
            <div class="progress-container">
                <div class="progress-bar" id="punching-progress"></div>
            </div>
        </div>
    </div>

    <div id="stretchPopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('stretch')">‚úï</button>
            <h4>Quick Stretch</h4>
            <p id="stretch-prompt">Follow the stretch instructions below.</p>
            <img id="stretch-image" src="/api/placeholder/200/150" alt="Stretch Image">
            <p id="stretch-timer">Time remaining: 60s</p>
            <div class="progress-container">
                <div class="progress-bar" id="stretch-progress"></div>
            </div>
            <button class="action-button" onclick="startStretch()">Start</button>
        </div>
    </div>

    <div id="doodlePopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('doodle')">‚úï</button>
            <h4>Doodle Pad</h4>
            <p>Draw freely to relax your mind for 90 seconds.</p>
            <div class="drawing-tools">
                <input type="color" id="color-picker" value="#000000">
                <label for="brush-size">Brush Size:</label>
                <input type="range" id="brush-size" min="1" max="10" value="2">
                <button class="action-button" onclick="clearCanvas()">Clear</button>
                <button class="action-button" onclick="saveDoodle()">Save</button>
            </div>
            <p id="doodle-timer">Time remaining: 90s</p>
            <div class="progress-container">
                <div class="progress-bar" id="doodle-progress"></div>
            </div>
            <canvas id="doodle-canvas"></canvas>
        </div>
    </div>

    <div id="dancePopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('dance')">‚úï</button>
            <h4>Dance Break</h4>
            <p id="dance-prompt">Get ready to dance!</p>
            <div id="dance-animation"></div>
            <div class="audio-controls">
                <button class="audio-btn" onclick="playDanceBeat()"><i class="fas fa-play"></i></button>
                <button class="audio-btn" onclick="pauseDanceBeat()"><i class="fas fa-pause"></i></button>
            </div>
            <p id="dance-timer">Time remaining: 30s</p>
            <div class="progress-container">
                <div class="progress-bar" id="dance-progress"></div>
            </div>
        </div>
    </div>

    <div id="worryPopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('worry')">‚úï</button>
            <h4>Worry Shredder</h4>
            <p>Type your worry, then shred it!</p>
            <textarea id="worry-text" placeholder="I‚Äôm worried about..."></textarea>
            <div id="paper-strips-container"></div>
            <button class="action-button" onclick="shredWorry()">Shred It</button>
        </div>
    </div>

    <div id="colorPopup" class="popup">
        <div class="popup-content">
            <button class="close-button" onclick="closePopup('color')">‚úï</button>
            <h4>Color Shift</h4>
            <p id="color-prompt">Focus on the color to relax.</p>
            <div id="color-square"></div>
            <p id="color-timer">Time remaining: 60s</p>
            <div class="progress-container">
                <div class="progress-bar" id="color-progress"></div>
            </div>
            <button class="action-button" onclick="startColorFocus()">Start</button>
        </div>
    </div>

    <script>
        // Add scroll effect for nav
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('nav');
            if (window.scrollY > 50) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });

        // Scroll to mood prompt
        function scrollToMoodPrompt() {
            document.getElementById('mood-prompt').scrollIntoView({ behavior: 'smooth' });
            safeGtag('event', 'Get Started Click', { 'event_category': 'Hero', 'event_label': 'Get Started Button' });
        }

        // Safe gtag wrapper to prevent errors if gtag is not loaded
        function safeGtag(...args) {
            if (typeof gtag === 'function') {
                gtag(...args);
            } else {
                console.warn('gtag is not defined, skipping analytics event:', args);
            }
        }

        // Update progress bar (from Claude)
        function updateProgress(elementId, total, current) {
            const progressBar = document.getElementById(elementId);
            const percentage = ((total - current) / total) * 100;
            progressBar.style.width = percentage + '%';
        }

        // Sound setup
        const natureSounds = {
            rain: new Audio('sounds/rain.mp3'),
            waves: new Audio('sounds/waves.mp3'),
            forest: new Audio('sounds/forest.mp3')
        };
        let currentSound = null;
        const successSound = new Audio('sounds/success.mp3');
        const punchSound = new Audio('sounds/punch.mp3');
        const shredSound = new Audio('sounds/shred.mp3');
        const danceAudio = new Audio('sounds/dance-beat.mp3');

        function playSound(sound, volume = 1) {
            if (sound) {
                sound.volume = volume;
                sound.currentTime = 0;
                sound.play().catch(error => {
                    console.error('Sound playback failed:', error);
                });
            }
        }

        // Existing moodTasks for follow-up questions
        const moodTasks = {
            tired: [
                { emoji: "‚òï", task: "Take 5 deep breaths to re-energize.", followUp: "Feel more awake?" },
                { emoji: "üí°", task: "Stand up and stretch for 30 seconds.", followUp: "Feel more alert?" },
                { emoji: "üé∂", task: "Listen to an upbeat song for a quick boost.", followUp: "Feeling energized?" }
            ],
            stressed: [
                { emoji: "üßò", task: "Try a 1-minute breathing exercise: inhale for 4, hold for 4, exhale for 4.", followUp: "Feel calmer?" },
                { emoji: "‚úçÔ∏è", task: "Write down what‚Äôs stressing you, then take a deep breath.", followUp: "Feel more in control?" },
                { emoji: "üö∂", task: "Take a quick 1-minute walk to clear your mind.", followUp: "Feel more relaxed?" }
            ],
            sad: [
                { emoji: "üíñ", task: "Think of one thing you‚Äôre grateful for today.", followUp: "Feel a bit brighter?" },
                { emoji: "üéµ", task: "Listen to a favorite song that lifts your spirits.", followUp: "Feeling better?" },
                { emoji: "ü§ó", task: "Text a friend or loved one to connect.", followUp: "Feel more supported?" }
            ],
            anxious: [
                { emoji: "üå≥", task: "Focus on 5 things you can see around you to ground yourself.", followUp: "Feel more present?" },
                { emoji: "üñêÔ∏è", task: "Place your hand on your heart and take 5 slow breaths.", followUp: "Feel calmer?" },
                { emoji: "üìù", task: "Write down your worry, then let it go for now.", followUp: "Feel less anxious?" }
            ],
            angry: [
                { emoji: "üëä", task: "Clench your fists, then release while exhaling slowly.", followUp: "Feel less tense?" },
                { emoji: "üì£", task: "Find a private space and let out a loud sigh or hum.", followUp: "Feel more released?" },
                { emoji: "üí®", task: "Take 5 deep breaths, exhaling longer than you inhale.", followUp: "Feel calmer?" }
            ],
            bored: [
                { emoji: "üé®", task: "Doodle on a piece of paper for 1 minute.", followUp: "Feel more engaged?" },
                { emoji: "üï∫", task: "Put on a song and dance for 30 seconds.", followUp: "Feeling more entertained?" },
                { emoji: "üí≠", task: "Think of a fun activity you‚Äôd like to do later today.", followUp: "Feel more inspired?" }
            ],
            happy: [
                { emoji: "üòÑ", task: "Share your happiness‚Äîtext a friend something positive!", followUp: "Feel even better?" },
                { emoji: "üéâ", task: "Celebrate with a quick dance or stretch.", followUp: "Still smiling?" },
                { emoji: "üì∏", task: "Take a moment to appreciate this feeling and smile.", followUp: "Feel the joy?" }
            ],
            lonely: [
                { emoji: "üìû", task: "Call or message a friend or family member.", followUp: "Feel more connected?" },
                { emoji: "üíå", task: "Write a kind note to yourself about your strengths.", followUp: "Feel more supported?" },
                { emoji: "üêæ", task: "If you have a pet, give them some love.", followUp: "Feel less alone?" }
            ]
        };

        // Enhanced mood-to-tool mapping with effectiveness ratings (1-5)
        const moodTools = {
            tired: [
                { tool: 'breathing', effectiveness: 4, reason: "Deep breathing increases oxygen to your brain and muscles" },
                { tool: 'stretch', effectiveness: 5, reason: "Physical movement stimulates blood flow and energy" },
                { tool: 'dance', effectiveness: 4, reason: "Gets your body moving and releases endorphins" },
                { tool: 'color', effectiveness: 3, reason: "Visual stimulation can increase alertness" }
            ],
            stressed: [
                { tool: 'breathing', effectiveness: 5, reason: "Activates parasympathetic nervous system to reduce stress" },
                { tool: 'punching', effectiveness: 4, reason: "Physical release of tension" },
                { tool: 'soundscape', effectiveness: 4, reason: "Auditory distraction and calming effect" },
                { tool: 'worry', effectiveness: 3, reason: "Helps process and release concerns" }
            ],
            sad: [
                { tool: 'gratitude', effectiveness: 5, reason: "Shifts focus to positive aspects in your life" },
                { tool: 'dance', effectiveness: 4, reason: "Movement and music boost mood-enhancing hormones" },
                { tool: 'color', effectiveness: 3, reason: "Color therapy can influence emotional state" },
                { tool: 'doodle', effectiveness: 3, reason: "Creative expression helps process emotions" }
            ],
            anxious: [
                { tool: 'breathing', effectiveness: 5, reason: "Slows heart rate and induces relaxation" },
                { tool: 'worry', effectiveness: 4, reason: "Externalizes and processes anxious thoughts" },
                { tool: 'soundscape', effectiveness: 4, reason: "Provides grounding sensory input" },
                { tool: 'doodle', effectiveness: 3, reason: "Mindful activity redirects anxious energy" }
            ],
            angry: [
                { tool: 'punching', effectiveness: 5, reason: "Safe physical outlet for anger" },
                { tool: 'breathing', effectiveness: 4, reason: "Calms physiological anger response" },
                { tool: 'worry', effectiveness: 3, reason: "Helps process and understand angry feelings" },
                { tool: 'stretch', effectiveness: 3, reason: "Releases physical tension stored in muscles" }
            ],
            bored: [
                { tool: 'dance', effectiveness: 5, reason: "Provides immediate stimulation and fun" },
                { tool: 'doodle', effectiveness: 4, reason: "Creative engagement activates mind" },
                { tool: 'color', effectiveness: 4, reason: "Visual engagement and focus" },
                { tool: 'stretch', effectiveness: 3, reason: "Physical activity shifts energy" }
            ],
            happy: [
                { tool: 'dance', effectiveness: 5, reason: "Amplifies positive feelings through movement" },
                { tool: 'gratitude', effectiveness: 5, reason: "Reinforces and extends positive emotions" },
                { tool: 'doodle', effectiveness: 3, reason: "Channel creative energy in a positive state" },
                { tool: 'color', effectiveness: 3, reason: "Extends the positive sensory experience" }
            ],
            lonely: [
                { tool: 'gratitude', effectiveness: 4, reason: "Fosters connection with positive aspects of life" },
                { tool: 'soundscape', effectiveness: 4, reason: "Creates ambient presence and comfort" },
                { tool: 'dance', effectiveness: 3, reason: "Self-expression and connection with music" },
                { tool: 'doodle', effectiveness: 3, reason: "Self-expression and creative connection" }
            ]
        };

        // User mood and activity tracking
        let userPreferences = {
            lastMood: null,
            activityHistory: [],
            favorites: [],
            achievements: {
                moodVariety: 0,
                activityCompletions: 0,
                streakDays: 0
            }
        };

        // Load user data from localStorage
        function loadUserData() {
            const savedData = localStorage.getItem('moodTaskUserData');
            if (savedData) {
                userPreferences = JSON.parse(savedData);
                
                // Update UI based on saved data
                if (userPreferences.lastMood) {
                    const moodButton = document.querySelector(`button[data-mood="${userPreferences.lastMood}"]`);
                    if (moodButton) moodButton.classList.add('last-selected');
                }
                
                updateAchievementDisplay();
            }

            // Check for streak
            const lastVisit = localStorage.getItem('moodTaskLastVisit');
            const today = new Date().toDateString();
            
            if (lastVisit) {
                const lastDate = new Date(lastVisit);
                const dayDifference = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
                
                if (dayDifference === 1) {
                    userPreferences.achievements.streakDays++;
                    showStreakNotification(userPreferences.achievements.streakDays);
                } else if (dayDifference > 1) {
                    userPreferences.achievements.streakDays = 1;
                }
            }
            
            localStorage.setItem('moodTaskLastVisit', today);
            saveUserData();
        }

        // Save user data to localStorage
        function saveUserData() {
            localStorage.setItem('moodTaskUserData', JSON.stringify(userPreferences));
        }

        // Show streak notification
        function showStreakNotification(days) {
            const notification = document.createElement('div');
            notification.className = 'streak-notification';
            notification.innerHTML = `
                <div class="streak-icon">üî•</div>
                <div class="streak-text">
                    <h4>${days} Day Streak!</h4>
                    <p>You're making mood improvement a habit</p>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        // Display achievement progress
        function updateAchievementDisplay() {
            let achievementSection = document.getElementById('achievements');
            
            if (!achievementSection) {
                achievementSection = document.createElement('div');
                achievementSection.id = 'achievements';
                achievementSection.className = 'achievement-section';
                achievementSection.innerHTML = `
                    <h3>Your Progress</h3>
                    <div class="achievement-grid"></div>
                `;
                document.getElementById('result').after(achievementSection);
            }
            
            const achievementGrid = achievementSection.querySelector('.achievement-grid');
            achievementGrid.innerHTML = `
                <div class="achievement-card">
                    <div class="achievement-icon">üîç</div>
                    <div class="achievement-info">
                        <h4>Mood Explorer</h4>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${Math.min(userPreferences.achievements.moodVariety/8*100, 100)}%"></div>
                        </div>
                        <p>${userPreferences.achievements.moodVariety}/8 different moods explored</p>
                    </div>
                </div>
                <div class="achievement-card">
                    <div class="achievement-icon">üèÜ</div>
                    <div class="achievement-info">
                        <h4>Activity Master</h4>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${Math.min(userPreferences.achievements.activityCompletions/20*100, 100)}%"></div>
                        </div>
                        <p>${userPreferences.achievements.activityCompletions}/20 activities completed</p>
                    </div>
                </div>
                <div class="achievement-card">
                    <div class="achievement-icon">üî•</div>
                    <div class="achievement-info">
                        <h4>Consistency Streak</h4>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${Math.min(userPreferences.achievements.streakDays/7*100, 100)}%"></div>
                        </div>
                        <p>${userPreferences.achievements.streakDays} day streak</p>
                    </div>
                </div>
            `;
        }

        // Highlight recommended tools based on selected mood
        function highlightRecommendedTools(mood) {
            document.querySelectorAll('.tool-button').forEach(tool => {
                tool.classList.remove('highly-recommended', 'recommended', 'somewhat-recommended');
                tool.querySelector('.effectiveness-badge')?.remove();
            });
            
            if (!mood) return;
            
            const recommendations = moodTools[mood];
            
            recommendations.forEach(rec => {
                const toolButton = document.querySelector(`.tool-button.${rec.tool}`);
                if (!toolButton) return;
                
                if (rec.effectiveness >= 5) {
                    toolButton.classList.add('highly-recommended');
                } else if (rec.effectiveness >= 4) {
                    toolButton.classList.add('recommended');
                } else {
                    toolButton.classList.add('somewhat-recommended');
                }
                
                const badge = document.createElement('div');
                badge.className = 'effectiveness-badge';
                badge.innerHTML = `${rec.effectiveness}/5`;
                
                toolButton.setAttribute('data-reason', rec.reason);
                toolButton.appendChild(badge);
            });
            
            const topRecommendation = recommendations.sort((a, b) => b.effectiveness - a.effectiveness)[0];
            if (topRecommendation) {
                const topToolButton = document.querySelector(`.tool-button.${topRecommendation.tool}`);
                if (topToolButton) {
                    topToolButton.classList.add('pulse-animation');
                    
                    const tryThisFlag = document.createElement('div');
                    tryThisFlag.className = 'try-this-flag';
                    tryThisFlag.textContent = 'Try this!';
                    topToolButton.appendChild(tryThisFlag);
                }
            }
        }

        // Enhanced task display
        function showTask(mood) {
            const tasks = moodTasks[mood];
            const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
            const recommendations = moodTools[mood];
            const topRecommendation = recommendations.sort((a, b) => b.effectiveness - a.effectiveness)[0];
            const resultDiv = document.getElementById('result');
            
            resultDiv.innerHTML = `
                <div class="chat-bubble animated-entry">
                    <div class="task-header">
                        <span class="mood-emoji">${randomTask.emoji}</span>
                        <h3>Task for ${mood.charAt(0).toUpperCase() + mood.slice(1)}</h3>
                    </div>
                    <p class="task-text">Try the <strong>${topRecommendation.tool.replace('-', ' ')}</strong> tool - ${topRecommendation.reason}.</p>
                    <div class="timer-container" id="taskTimer">
                        <button class="timer-button" onclick="startTaskTimer(30)">
                            <i class="fas fa-stopwatch"></i> Start 30s Timer
                        </button>
                        <div class="timer-progress">
                            <div class="timer-bar"></div>
                        </div>
                        <span class="timer-text"></span>
                    </div>
                    <p class="follow-up-question">${randomTask.followUp}</p>
                    <div class="reaction-buttons">
                        <button class="reaction-button" onclick="recordReaction('${mood}', '${topRecommendation.tool}', 'didnt-help')">
                            <span class="reaction-icon">üëé</span> Didn't help
                        </button>
                        <button class="reaction-button" onclick="recordReaction('${mood}', '${topRecommendation.tool}', 'somewhat-helped')">
                            <span class="reaction-icon">üëå</span> Somewhat helped
                        </button>
                        <button class="reaction-button" onclick="recordReaction('${mood}', '${topRecommendation.tool}', 'really-helped')">
                            <span class="reaction-icon">üëç</span> Really helped!
                        </button>
                    </div>
                    <div class="task-buttons">
                        <button class="favorite-button" onclick="saveFavorite('${mood}', '${topRecommendation.tool}')">
                            <span class="heart-icon">‚ù§Ô∏è</span> Favorite
                        </button>
                        <button class="new-task-button" onclick="showTask('${mood}')">New Task</button>
                    </div>
                </div>
            `;
            
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Task timer functionality
        function startTaskTimer(seconds) {
            const timerContainer = document.getElementById('taskTimer');
            const timerButton = timerContainer.querySelector('.timer-button');
            const timerBar = timerContainer.querySelector('.timer-bar');
            const timerText = timerContainer.querySelector('.timer-text');
            
            timerButton.style.display = 'none';
            timerBar.style.display = 'block';
            timerText.style.display = 'block';
            
            let timeLeft = seconds;
            timerText.textContent = `${timeLeft}s`;
            timerBar.style.width = '100%';
            
            const interval = setInterval(() => {
                timeLeft--;
                timerText.textContent = `${timeLeft}s`;
                timerBar.style.width = `${(timeLeft/seconds)*100}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    timerText.textContent = 'Complete!';
                    showCompletionConfetti();
                    userPreferences.achievements.activityCompletions++;
                    saveUserData();
                    updateAchievementDisplay();
                }
            }, 1000);
        }

        // Confetti effect for task completion
        function showCompletionConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            document.body.appendChild(confettiContainer);
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.setProperty('--fall-duration', `${Math.random() * 3 + 2}s`);
                confetti.style.setProperty('--fall-delay', `${Math.random() * 2}s`);
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
                confettiContainer.appendChild(confetti);
            }
            
            setTimeout(() => {
                confettiContainer.remove();
            }, 5000);
        }

        // Record user's reaction to the task
        function recordReaction(mood, task, reaction) {
            userPreferences.activityHistory.push({
                mood: mood,
                task: task,
                reaction: reaction,
                timestamp: new Date().toISOString()
            });
            
            saveUserData();
            
            const reactionButtons = document.querySelector('.reaction-buttons');
            reactionButtons.innerHTML = '<p class="reaction-feedback">Thanks for your feedback!</p>';
            
            if (reaction === 'didnt-help') {
                const recommendations = moodTools[mood];
                const topRecommendation = recommendations.sort((a, b) => b.effectiveness - a.effectiveness)[0];
                
                if (topRecommendation) {
                    reactionButtons.innerHTML += `
                        <p class="tool-suggestion">
                            Try the <strong>${topRecommendation.tool.replace('-', ' ')}</strong> tool - 
                            ${topRecommendation.reason}.
                            <button class="try-tool-button" onclick="openPopup('${topRecommendation.tool}')">
                                Try Now
                            </button>
                        </p>
                    `;
                }
            }
            
            safeGtag('event', 'Task Reaction', { 
                'event_category': 'Task', 
                'event_label': `${mood} - ${reaction}` 
            });
        }

        // Enhanced Save favorite task
        function saveFavorite(mood, task) {
            if (!userPreferences.favorites.some(fav => fav.mood === mood && fav.task === task)) {
                userPreferences.favorites.push({
                    mood: mood,
                    task: task,
                    timestamp: new Date().toISOString()
                });
                
                saveUserData();
                
                const favoriteButton = document.querySelector('.favorite-button');
                favoriteButton.innerHTML = '<span class="heart-icon animated-heart">‚ù§Ô∏è</span> Saved!';
                favoriteButton.disabled = true;
            }
            
            safeGtag('event', 'Favorite Task', { 'event_category': 'Task', 'event_label': `${mood} - ${task}` });
        }

        // Enhanced tool popup opening
        function openPopup(tool) {
            const popup = document.getElementById(`${tool}Popup`);
            popup.style.display = 'flex';
            popup.classList.add('popup-entering');
            
            setTimeout(() => {
                popup.classList.remove('popup-entering');
            }, 300);
            
            if (tool === 'doodle') startDoodle();
            if (tool === 'breathing') prepareBreathingCircle();
            if (tool === 'color') prepareColorShift();
            if (tool === 'punching') startPunching();
            if (tool === 'soundscape') startSoundscape();
            
            userPreferences.activityHistory.push({
                type: 'tool',
                tool: tool,
                timestamp: new Date().toISOString()
            });
            
            saveUserData();
            safeGtag('event', 'Tool Opened', { 'event_category': 'Tool', 'event_label': tool });
        }

        // Close popup
        function closePopup(tool) {
            document.getElementById(`${tool}Popup`).style.display = 'none';
            if (tool === 'soundscape') {
                if (currentSound) {
                    currentSound.pause();
                    currentSound = null;
                }
                if (window.soundscapeInterval) clearInterval(window.soundscapeInterval);
            }
            if (tool === 'dance') pauseDanceBeat();
            if (tool === 'breathing' && window.breathingInterval) clearInterval(window.breathingInterval);
            if (tool === 'punching' && window.punchingInterval) clearInterval(window.punchingInterval);
            if (tool === 'stretch' && window.stretchInterval) clearInterval(window.stretchInterval);
            if (tool === 'doodle' && window.doodleInterval) clearInterval(window.doodleInterval);
            if (tool === 'dance' && window.danceInterval) clearInterval(window.danceInterval);
            if (tool === 'color' && window.colorInterval) clearInterval(window.colorInterval);
        }

        // Prepare breathing circle
        function prepareBreathingCircle() {
            const circle = document.getElementById('breathing-circle');
            const stepElement = document.getElementById('breathing-step');
            const instructionElement = document.getElementById('breathing-instruction');
            const timerElement = document.getElementById('breathing-timer');
            
            circle.className = '';
            stepElement.textContent = 'Inhale';
            instructionElement.textContent = 'Click Start to begin';
            timerElement.textContent = 'Time remaining: 60s';
            updateProgress('breathing-progress', 60, 0);
        }

        // Breathing Exercise: Enhanced with visual circle animation (from Claude)
        function startBreathing() {
            let time = 60;
            let step = 0;
            const steps = [
                { text: "Inhale", instruction: "Breathe in slowly through your nose...", class: "inhale" },
                { text: "Hold", instruction: "Hold your breath...", class: "hold" },
                { text: "Exhale", instruction: "Breathe out slowly through your mouth...", class: "exhale" }
            ];
            const stepElement = document.getElementById('breathing-step');
            const instructionElement = document.getElementById('breathing-instruction');
            const timerElement = document.getElementById('breathing-timer');
            const circle = document.getElementById('breathing-circle');
            
            // Reset
            circle.className = '';
            updateProgress('breathing-progress', 60, 0);
            
            function updateBreathing() {
                if (time % 4 === 0) {
                    step = (step % 3);
                    stepElement.textContent = steps[step].text;
                    instructionElement.textContent = steps[step].instruction;
                    circle.className = steps[step].class;
                    step++;
                }
                
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('breathing-progress', 60, time);
                
                if (time <= 0) {
                    clearInterval(window.breathingInterval);
                    playSound(successSound, 0.4);
                    setTimeout(() => closePopup('breathing'), 1500);
                }
            }
            
            updateBreathing(); // Initial update
            window.breathingInterval = setInterval(updateBreathing, 1000);
        }

        // Soundscape: Enhanced with different sound options and volume control (from Claude)
        function startSoundscape() {
            let time = 90;
            const timerElement = document.getElementById('soundscape-timer');
            const selectElement = document.getElementById('soundscape-select');
            const playButton = document.getElementById('play-btn');
            const volumeSlider = document.getElementById('volume-slider');
            
            // Reset
            updateProgress('soundscape-progress', 90, 0);
            
            // Set up play button
            playButton.onclick = function() {
                const soundType = selectElement.value;
                if (currentSound) currentSound.pause();
                currentSound = natureSounds[soundType];
                currentSound.volume = volumeSlider.value;
                currentSound.play().catch(error => {
                    console.error('Sound playback failed:', error);
                    alert('Sound playback failed. Please ensure your browser allows audio playback.');
                });
                playButton.innerHTML = '<i class="fas fa-pause"></i>';
                playButton.onclick = function() {
                    if (currentSound.paused) {
                        currentSound.play();
                        playButton.innerHTML = '<i class="fas fa-pause"></i>';
                    } else {
                        currentSound.pause();
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                    }
                };
            };
            
            // Set up volume control
            volumeSlider.oninput = function() {
                if (currentSound) currentSound.volume = this.value;
            };
            
            window.soundscapeInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('soundscape-progress', 90, time);
                
                if (time <= 0) {
                    clearInterval(window.soundscapeInterval);
                    if (currentSound) {
                        // Fade out the sound
                        const fadeInterval = setInterval(() => {
                            if (currentSound.volume > 0.1) {
                                currentSound.volume -= 0.1;
                            } else {
                                currentSound.pause();
                                clearInterval(fadeInterval);
                                playSound(successSound, 0.4);
                                setTimeout(() => closePopup('soundscape'), 1500);
                            }
                        }, 100);
                    } else {
                        playSound(successSound, 0.4);
                        setTimeout(() => closePopup('soundscape'), 1500);
                    }
                }
            }, 1000);
        }

        // Punching Bag: Enhanced with animation and sound effects (from Claude)
        function startPunching() {
            let time = 30;
            let count = 0;
            const bag = document.getElementById('punching-bag');
            const timerElement = document.getElementById('punching-timer');
            
            // Reset
            bag.textContent = '0';
            bag.style.transform = 'scale(1)';
            updateProgress('punching-progress', 30, 0);
            
            bag.onclick = () => {
                count++;
                bag.textContent = count;
                playSound(punchSound, 0.3);
                
                bag.style.transform = 'scale(0.9) rotate(-5deg)';
                setTimeout(() => {
                    bag.style.transform = 'scale(1) rotate(0)';
                }, 150);
            };
            
            window.punchingInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('punching-progress', 30, time);
                
                if (time <= 0) {
                    clearInterval(window.punchingInterval);
                    playSound(successSound, 0.4);
                    bag.textContent = count;
                    bag.innerHTML = `<span>Great job!</span><br>${count}`;
                    setTimeout(() => closePopup('punching'), 2000);
                }
            }, 1000);
        }

        // Stretch: Enhanced with images and detailed instructions (from Claude)
        function startStretch() {
            let time = 60;
            const prompts = [
                { text: "Reach for the sky and hold for a few seconds.", img: "/api/placeholder/200/150" },
                { text: "Touch your toes and feel the stretch in your legs.", img: "/api/placeholder/200/150" },
                { text: "Stretch your arms behind your back and open your chest.", img: "/api/placeholder/200/150" },
                { text: "Gently roll your head from side to side.", img: "/api/placeholder/200/150" }
            ];
            const promptElement = document.getElementById('stretch-prompt');
            const timerElement = document.getElementById('stretch-timer');
            const imageElement = document.getElementById('stretch-image');
            
            // Choose a random stretch
            const randomStretch = prompts[Math.floor(Math.random() * prompts.length)];
            promptElement.textContent = randomStretch.text;
            imageElement.src = randomStretch.img;
            
            // Reset
            updateProgress('stretch-progress', 60, 0);
            
            window.stretchInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('stretch-progress', 60, time);
                
                if (time <= 0) {
                    clearInterval(window.stretchInterval);
                    playSound(successSound, 0.4);
                    setTimeout(() => closePopup('stretch'), 1500);
                }
            }, 1000);
        }

        // Doodle: Enhanced with color picker and brush size options (from Claude)
        function startDoodle() {
            let time = 90;
            const canvas = document.getElementById('doodle-canvas');
            const ctx = canvas.getContext('2d');
            const timerElement = document.getElementById('doodle-timer');
            const colorPicker = document.getElementById('color-picker');
            const brushSize = document.getElementById('brush-size');
            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Reset canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            updateProgress('doodle-progress', 90, 0);
            
            // Drawing functions
            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            }
            
            function draw(e) {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.strokeStyle = colorPicker.value;
                ctx.lineWidth = brushSize.value;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            }
            
            function stopDrawing() {
                drawing = false;
            }
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch support
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', () => {
                const mouseEvent = new MouseEvent('mouseup');
                canvas.dispatchEvent(mouseEvent);
            });
            
            window.doodleInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('doodle-progress', 90, time);
                
                if (time <= 0) {
                    clearInterval(window.doodleInterval);
                    playSound(successSound, 0.4);
                    // Don't close automatically to allow saving
                }
            }, 1000);
        }

        // Clear canvas function (from Claude)
        function clearCanvas() {
            const canvas = document.getElementById('doodle-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Save doodle function (from Claude)
        function saveDoodle() {
            const canvas = document.getElementById('doodle-canvas');
            const link = document.createElement('a');
            link.download = 'my-doodle-' + new Date().toISOString().slice(0, 10) + '.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Dance: Enhanced with animation and better prompts (from Claude)
        function startDance() {
            let time = 30;
            const prompts = [
                "Spin around and let loose! Feel the rhythm!",
                "Do a little shimmy to your own beat!",
                "Jump up and down with joy! Release that energy!",
                "Wave your arms like you just don't care!"
            ];
            const promptElement = document.getElementById('dance-prompt');
            const timerElement = document.getElementById('dance-timer');
            const animation = document.getElementById('dance-animation');
            
            // Choose a random dance prompt
            promptElement.textContent = prompts[Math.floor(Math.random() * prompts.length)];
            animation.innerHTML = '<i class="fas fa-child fa-4x" style="animation: bounce 1s infinite alternate;"></i>';
            
            // Reset
            updateProgress('dance-progress', 30, 0);
            
            // Play dance beat
            danceAudio.currentTime = 0;
            danceAudio.play().catch(error => {
                console.error('Dance audio playback failed:', error);
            });
            
            window.danceInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('dance-progress', 30, time);
                
                if (time <= 0) {
                    clearInterval(window.danceInterval);
                    danceAudio.pause();
                    playSound(successSound, 0.4);
                    setTimeout(() => closePopup('dance'), 1500);
                }
            }, 1000);
        }

        function playDanceBeat() {
            if (danceAudio.paused) {
                danceAudio.play();
            }
        }

        function pauseDanceBeat() {
            if (danceAudio) danceAudio.pause();
            if (window.danceInterval) clearInterval(window.danceInterval);
            document.getElementById('dance-progress').style.width = '100%';
        }

        // Worry Shredder: Enhanced with animation effect (from Claude)
        function shredWorry() {
            const worryText = document.getElementById('worry-text');
            const paperStripsContainer = document.getElementById('paper-strips-container');
            
            if (worryText.value.trim() === '') {
                alert('Please write a worry to shred!');
                return;
            }
            
            // Create paper strips animation
            paperStripsContainer.innerHTML = '';
            const numStrips = 10;
            
            for (let i = 0; i < numStrips; i++) {
                const strip = document.createElement('div');
                strip.className = 'paper-strip';
                strip.style.cssText = `
                    position: absolute;
                    left: ${10 + (i * 8)}%;
                    top: 0;
                    width: 5%;
                    height: 30px;
                    background-color: #fff;
                    border: 1px solid #ddd;
                    transform-origin: top center;
                    animation: shred 1s forwards ${i * 0.1}s;
                `;
                paperStripsContainer.appendChild(strip);
            }
            
            // Play shredding sound
            playSound(shredSound);
            
            // Animate the textarea
            worryText.classList.add('shredding');
            
            setTimeout(() => {
                worryText.value = '';
                worryText.classList.remove('shredding');
                paperStripsContainer.innerHTML = '';
                
                // Show a confirmation
                const confirmation = document.createElement('div');
                confirmation.textContent = 'Worry shredded! Feel lighter?';
                confirmation.style.cssText = `
                    color: var(--success);
                    font-weight: 500;
                    margin: 15px 0;
                    animation: fadeIn 0.5s forwards;
                `;
                paperStripsContainer.appendChild(confirmation);
                
                setTimeout(() => {
                    closePopup('worry');
                }, 2000);
            }, 1000);
        }

        // Prepare color shift
        function prepareColorShift() {
            const square = document.getElementById('color-square');
            const promptElement = document.getElementById('color-prompt');
            const timerElement = document.getElementById('color-timer');
            
            square.style.backgroundColor = '#1E90FF';
            square.style.transform = 'scale(1)';
            square.innerHTML = '';
            promptElement.textContent = 'Focus on the color to relax.';
            timerElement.textContent = 'Time remaining: 60s';
            updateProgress('color-progress', 60, 0);
        }

        // Color Focus: Enhanced with pulsing animation and more colors (from Claude)
        function startColorFocus() {
            let time = 60;
            const colors = [
                { name: "Blue to soothe your mind", hex: "#1E90FF" },
                { name: "Green to restore balance", hex: "#32CD32" },
                { name: "Yellow to uplift your spirit", hex: "#FFD700" },
                { name: "Purple to inspire creativity", hex: "#9370DB" },
                { name: "Turquoise to refresh", hex: "#40E0D0" }
            ];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            const promptElement = document.getElementById('color-prompt');
            const squareElement = document.getElementById('color-square');
            const timerElement = document.getElementById('color-timer');
            
            promptElement.textContent = `Focus on ${randomColor.name}`;
            squareElement.style.backgroundColor = randomColor.hex;
            
            // Add pulsing animation
            squareElement.style.animation = 'pulse 4s infinite';
            
            // Reset
            updateProgress('color-progress', 60, 0);
            
            window.colorInterval = setInterval(() => {
                time--;
                timerElement.textContent = `Time remaining: ${time}s`;
                updateProgress('color-progress', 60, time);
                
                if (time <= 0) {
                    clearInterval(window.colorInterval);
                    playSound(successSound, 0.4);
                    setTimeout(() => closePopup('color'), 1500);
                }
            }, 1000);
        }

        // Gratitude Note: Enhanced with confirmation and storage (from Claude)
        function saveGratitude() {
            const gratitudeText = document.getElementById('gratitude-text');
            
            if (gratitudeText.value.trim() === '') {
                alert('Please write something you\'re grateful for!');
                return;
            }
            
            // Store in localStorage if available
            if (typeof Storage !== "undefined") {
                const gratitudeList = JSON.parse(localStorage.getItem('gratitudeList') || '[]');
                gratitudeList.push({
                    text: gratitudeText.value,
                    date: new Date().toISOString()
                });
                localStorage.setItem('gratitudeList', JSON.stringify(gratitudeList));
            }
            
            // Play success sound
            playSound(successSound, 0.4);
            
            // Show confirmation with animation
            gratitudeText.style.transition = 'all 0.3s';
            gratitudeText.style.backgroundColor = '#e6ffe6';
            gratitudeText.style.borderColor = '#27ae60';
            
            setTimeout(() => {
                alert('Gratitude saved! Feeling more thankful?');
                closePopup('gratitude');
            }, 1000);
        }

        // Share on X
        function setupShareButton() {
            document.getElementById('share').addEventListener('click', () => {
                const url = encodeURIComponent(window.location.href);
                const text = encodeURIComponent('Boost your mood with MoodTask! Select your mood and get a quick, science-backed task to feel better. #MoodBoost');
                window.open(`https://x.com/intent/tweet?url=${url}&text=${text}`, '_blank');
                safeGtag('event', 'Share', { 'event_category': 'Social', 'event_label': 'X Share' });
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, setting up event listeners...');

            // Load user data
            loadUserData();
            
            // Add personal greeting based on time of day
            const greeting = document.getElementById('instruction');
            const hour = new Date().getHours();
            let timeBasedGreeting = '';
            if (hour < 12) {
                timeBasedGreeting = 'Good Morning! ';
            } else if (hour < 18) {
                timeBasedGreeting = 'Good Afternoon! ';
            } else {
                timeBasedGreeting = 'Good Evening! ';
            }
            greeting.textContent = timeBasedGreeting + 'How Are You Feeling Right Now?';
            
            // If user has a previous mood, highlight recommended tools
            if (userPreferences.lastMood) {
                highlightRecommendedTools(userPreferences.lastMood);
            }
            
            // Preload sounds
            const sounds = ['rain', 'waves', 'forest', 'dance-beat', 'success', 'punch', 'shred'];
            sounds.forEach(sound => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.src = `sounds/${sound}.mp3`;
            });

            // Setup mood button event listeners
            const moodButtons = document.querySelectorAll('#mood-buttons button');
            console.log(`Found ${moodButtons.length} mood buttons`);
            moodButtons.forEach(button => {
                button.addEventListener('click', () => {
                    console.log(`Mood button clicked: ${button.getAttribute('data-mood')}`);
                    document.querySelectorAll('#mood-buttons button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    
                    const mood = button.getAttribute('data-mood');
                    userPreferences.lastMood = mood;
                    const uniqueMoods = new Set([...userPreferences.activityHistory.map(item => item.mood), mood]);
                    userPreferences.achievements.moodVariety = uniqueMoods.size;
                    saveUserData();
                    showTask(mood);
                    highlightRecommendedTools(mood);
                    safeGtag('event', 'Mood Selection', { 'event_category': 'Mood', 'event_label': mood });
                });
            });

            // Setup share button
            setupShareButton();

            // Add ripple effect to buttons (from Claude)
            const buttons = document.querySelectorAll('.tool-button, .action-button');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    this.appendChild(ripple);
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    ripple.style.width = ripple.style.height = `${size}px`;
                    
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });
    </script>
</body>
</html>
